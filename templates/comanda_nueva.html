
{% extends 'base.html' %}
{% block title %}Nueva comanda{% endblock %}
{% block content %}
<h3>Nueva comanda</h3>
<form method="post" enctype="multipart/form-data" onsubmit="return submitOrder()">
  <div class="row g-2">
    <div class="col-md-4">
      <label class="form-label">Quién pide el producto</label>
      <input class="form-control" name="requested_by" placeholder="Nombre o email" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Hora deseada</label>
      <select class="form-select" name="requested_for_time" required>
        {% for s in time_slots %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
      </select>
    </div>
  </div>
  <hr>
  <h6>Productos (puedes escribir código de barras y/o nombre — no es obligatorio que existan en catálogo)</h6>
  <div id="items"></div>
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addRow()">+ Agregar</button>
  <input type="hidden" name="items_json" id="items_json">
  <div class="mt-3"><button class="btn btn-primary">Crear comanda</button></div>
</form>

<script>
let rowIdx = 0;
function rowTpl(i){ return `
  <div class="border rounded p-2 mb-2 item" data-i="${i}">
    <div class="row g-2 align-items-end">
      <div class="col-md-3"><label class="form-label">SKU / Código</label><input class="form-control sku" placeholder="Puede ser los últimos 4 dígitos"></div>
      <div class="col-md-4 position-relative">
        <label class="form-label">Nombre</label>
        <input class="form-control nombre" placeholder="Autocompleta si existe">
        <div class="autocomplete-list d-none"></div>
      </div>
      <div class="col-md-2"><label class="form-label">Cantidad</label><input type="number" class="form-control cantidad" min="1" value="1"></div>
      <div class="col-md-3"><label class="form-label">Foto (subir o cámara)</label><input type="file" class="form-control foto" accept="image/*" capture="environment" name="foto_${i}"></div>
    </div>
    <div class="small mt-1 text-muted stock-info"></div>
    <div class="mt-1"><button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.item').remove()">Quitar</button></div>
  </div>`; }

function addRow(){
  const i = rowIdx++;
  document.getElementById('items').insertAdjacentHTML('beforeend', rowTpl(i));
  setupAutocomplete(i);
}
addRow();

async function searchProducts(q){
  const res = await fetch('/api/search?q='+encodeURIComponent(q));
  return await res.json();
}
function setupAutocomplete(i){
  const wrap = document.querySelector(`.item[data-i="${i}"]`);
  const sku = wrap.querySelector('.sku');
  const nombre = wrap.querySelector('.nombre');
  const ac = wrap.querySelector('.autocomplete-list');
  async function doAC(){
    const q = (nombre.value || sku.value).trim();
    if(!q){ ac.classList.add('d-none'); ac.innerHTML=''; return; }
    const data = await searchProducts(q);
    ac.innerHTML = data.map(d => `
      <div class="autocomplete-item" data-sku="${d.sku}" data-nombre="${d.nombre}" data-stock="${d.stock}">
        ${d.foto_producto ? `<img class="autocomplete-thumb" src="${d.foto_producto}">` : ''}
        <div>
          <div><strong>${d.nombre}</strong> <small class="text-muted">SKU ${d.sku}</small></div>
          <div class="text-muted small">Pasillo: ${d.pasillo || '-'}</div>
        </div>
      </div>`).join('');
    ac.classList.toggle('d-none', data.length===0);
  }
  nombre.addEventListener('input', () => { clearTimeout(nombre._t); nombre._t = setTimeout(doAC, 160); });
  sku.addEventListener('input', () => { clearTimeout(sku._t); sku._t = setTimeout(doAC, 160); });
  ac.addEventListener('click', (e) => {
    const it = e.target.closest('.autocomplete-item'); if(!it) return;
    nombre.value = it.dataset.nombre;
    sku.value = it.dataset.sku;
    wrap.querySelector('.stock-info').textContent = `Stock disponible: ${it.dataset.stock}`;
    ac.classList.add('d-none');
  });
}

function submitOrder(){
  const items = [];
  document.querySelectorAll('.item').forEach(wrap => {
    const sku = wrap.querySelector('.sku').value.trim() || null;
    const nombre = wrap.querySelector('.nombre').value.trim();
    const cantidad = parseInt(wrap.querySelector('.cantidad').value || '1');
    const photoField = wrap.querySelector('.foto').getAttribute('name');
    if(!nombre) return;
    items.push({sku, nombre, cantidad, photo_fields:[photoField]});
  });
  if(items.length===0){ alert('Agrega al menos un producto'); return false; }
  document.getElementById('items_json').value = JSON.stringify(items);
  return true;
}
</script>
{% endblock %}


{% extends 'base.html' %}
{% block title %}Buscador{% endblock %}
{% block content %}
<h3>Buscador</h3>
<div class="position-relative">
  <input id="search" class="form-control" placeholder="Buscar por nombre, SKU o últimos 4 dígitos...">
  <div id="ac" class="autocomplete-list d-none"></div>
</div>
<div id="results" class="mt-3"></div>
{% endblock %}
{% block scripts %}
<script>
const input = document.getElementById('search');
const ac = document.getElementById('ac');
const results = document.getElementById('results');
let timer = null;
input.addEventListener('input', function(){
  clearTimeout(timer);
  const q = this.value.trim();
  if(!q){ ac.classList.add('d-none'); ac.innerHTML=''; results.innerHTML=''; return; }
  timer = setTimeout(async () => {
    const res = await fetch('/api/search?q='+encodeURIComponent(q));
    const data = await res.json();
    ac.innerHTML = data.map(d => `
      <div class="autocomplete-item" data-id="${d.id}">
        ${d.foto_producto ? `<img class="autocomplete-thumb" src="${d.foto_producto}">` : ''}
        <div>
          <div><strong>${d.nombre}</strong> <small class="text-muted">SKU ${d.sku}</small></div>
          <div class="text-muted small">Pasillo: ${d.pasillo || '-'}</div>
        </div>
      </div>`).join('');
    ac.classList.toggle('d-none', data.length===0);
  }, 180);
});
ac.addEventListener('click', async (e) => {
  const item = e.target.closest('.autocomplete-item'); if(!item) return;
  ac.classList.add('d-none'); input.value='';
  const id = item.getAttribute('data-id');
  const res = await fetch('/api/search?q='+encodeURIComponent(id));
  const data = await res.json();
  const d = data.find(x => x.id == id) || data[0];
  if(!d) return;
  results.innerHTML = `
    <div class="card">
      <div class="card-body d-flex gap-3">
        ${d.foto_producto ? `<img src="${d.foto_producto}" height="110">` : ''}
        <div>
          <h5>${d.nombre} <small class="text-muted">SKU ${d.sku}</small></h5>
          <div>Pasillo: <strong>${d.pasillo || '-'}</strong> | Rack: ${d.rack || '-'}</div>
          <div>Stock: <strong>${d.stock}</strong></div>
          <a class="btn btn-sm btn-outline-primary mt-2" href="/producto/${d.id}">Ver detalle</a>
        </div>
      </div>
    </div>`;
});
</script>
{% endblock %}

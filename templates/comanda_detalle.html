
{% extends 'base.html' %}
{% block title %}Comanda #{{ order.id }}{% endblock %}
{% block content %}
<h3>Comanda #{{ order.id }}</h3>
<div class="card mb-3">
  <div class="card-body d-flex justify-content-between">
    <div>
      <div><strong>Solicitante:</strong> {{ order.requested_by }}</div>
      <div><strong>Hora deseada:</strong> {{ order.requested_for_time }}</div>
      <div><strong>Estado:</strong> <span class="badge text-bg-{{ 'success' if order.status=='entregado' else 'warning' }}">{{ order.status }}</span></div>
      <div class="text-muted small">Creada: {{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
    </div>
    {% if current_user.is_authenticated and current_user.role in ['admin','bodeguero'] and order.status != 'entregado' %}
      <form method="post" action="{{ url_for('admin_comanda_entregar', order_id=order.id) }}">
        <button class="btn btn-success btn-sm">Marcar ENTREGADA</button>
      </form>
    {% endif %}
  </div>
</div>
<ul class="list-group">
  {% for it, foto in items %}
    <li class="list-group-item">
      <div class="d-flex gap-3 align-items-center">
        {% if foto %}<img src="{{ foto }}" height="60" class="rounded">{% endif %}
        <div>
          <div>{{ it.cantidad }} Ã— {{ it.nombre }} {% if it.sku %}<span class="text-muted">(SKU {{ it.sku }})</span>{% endif %}</div>
          {% if it.photos %}
            <div class="mt-2 d-flex gap-2 flex-wrap">
              {% for ph in it.photos %}
                <img src="{{ url_for('uploaded_file', filename=ph.filename) }}" height="70" class="rounded" data-bs-toggle="modal" data-bs-target="#modalImg" data-img="{{ url_for('uploaded_file', filename=ph.filename) }}">
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </li>
  {% endfor %}
</ul>

<div class="modal fade" id="modalImg" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content"><div class="modal-body p-0"><img id="modalImgTag" src="" class="w-100"></div></div>
  </div>
</div>
<script>
document.addEventListener('click', (e) => {
  const img = e.target.closest('img[data-img]'); if(!img) return;
  document.getElementById('modalImgTag').src = img.dataset.img;
});
</script>
{% endblock %}
